<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> -->
    <meta name="viewport" content="960px, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/static/style/basket.css" type="text/css" />
    <link rel="stylesheet" href="/static/style/food-card.css" type="text/css" />
    <link
      rel="stylesheet"
      href="/static/style/navbar-menu.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="/static/style/products-list.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="/static/style/style-modal.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="/static/style/wrapper-box.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="/static/style/modalReady.css"
      type="text/css"
    />

    <title>Document</title>
  </head>

  <body>
    <div class="wrapper">
      <div id="box1">
        <p>Сделай заказ</p>
      </div>
      <div id="box2">
        <nav class="navbar-menu" id="menu">
          <a href="#">Блины</a>
          <a href="/shaurma">Шаурма</a>
          <a href="/pizza">Пицца</a>
          <a href="/sandwiches">Сенгвичи </a>
          <a href="/burgers">Бургеры </a>
          <a href="/chicken">Курица & Картофель</a>
          <a href="/salads">Тортилья & Салаты </a>
          <a href="/drinks">Напитки & Десерты </a>
        </nav>
        <div class="basket-logo">
          <p>Корзина</p>
        </div>
        <div class="basket-body">
          <div class="basket-info">
            <p>Название</p>
            <p>Количество</p>
          </div>
          <div class="basket-products"></div>
          <hr />
          <p id="totalSumm">Итого: 0 руб</p>
          <button class="btn" type="submit">ОФОРМИТЬ ЗАКАЗ</button>
        </div>
      </div>

      <div id="box3"></div>
    </div>
    <script
      type="text/javascript"
      src="/static/scripts/deleteFoodBascet.js"
    ></script>
    <script type="text/javascript" src="/static/scripts/menuActive.js"></script>
    <script
      type="text/javascript"
      src="/static/scripts/setLocalStorageOrder.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/renderProductHtml.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/renderModalDialog.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/renderModalReady.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/renderFoodinBasket.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/loadingCartData.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/reloadingCartDataToClick.js"
    ></script>
    <script
      type="text/javascript"
      src="/static/scripts/calculationOfTheTotalPrice.js"
    ></script>

    <script>
      let contentBox3 = document.getElementById("box3");
      async function getResponse() {
        let response = await fetch("http://myjson.dit.upm.es/api/bins/9np0");
        let content = await response.json();
        return content;
      }

      class Products {
        constructor() {
          let typeProduct = "";
          let foods;
          this.order = [];
          this.local;
        }

        render() {
          let htmlCatalog = "";
          let i = 0;

          this.typeProduct = window.location.pathname.split("/")[1];
          console.log(this.typeProduct);
          getResponse().then((content) => {
            this.foods = content;
            console.log(content);
            content.menu.forEach((element) => {
              console.log(element.category);

              if (element.category === this.typeProduct) {
                renderListFood(
                  content,
                  htmlCatalog,
                  contentBox3,
                  i,
                  this.typeProduct
                );
              }
            });
          });
        }
        orderQuantity() {
          window.addEventListener("click", (event) => {
            if (event.target.id === "amount-food") {
              let card = event.target.closest("#food-card");
              let price = card.querySelectorAll("#discription-food p");
              let priceSplit = price[1].innerText.split(":")[1];
              event.target.addEventListener("input", (event) => {
                price[1].innerText = `Цена:${(
                  event.target.value * priceSplit
                ).toFixed(1)}`;
              });
            }

            if (event.target.id === "add-food") {
              let card = event.target.closest("#food-card");
              let price = card.querySelectorAll("#discription-food p");
              let priceSplit = price[1].innerText.split(":")[1];

              let counterWraper = event.target.closest("#buy-food");
              let counter = counterWraper.querySelector("#amount-food");
              counter.innerText = counter.value++;

              if (+counter.value > 2) {
                priceSplit = +priceSplit / (+counter.value - 1);
                price[1].innerText = `Цена:${(
                  priceSplit * +counter.value
                ).toFixed(1)}`;
              } else {
                price[1].innerText = `Цена:${+priceSplit * +counter.value}`;
              }
            }
            if (event.target.id === "delete-food") {
              let card = event.target.closest("#food-card");
              let price = card.querySelectorAll("#discription-food p");
              let priceSplit = price[1].innerText.split(":")[1];

              let counterWraper = event.target.closest("#buy-food");
              let counter = counterWraper.querySelector("#amount-food");

              if (counter.value > 1) {
                counter.innerText = counter.value--;

                if (+counter.value > 1) {
                  priceSplit = +priceSplit / (+counter.value + 1);

                  price[1].innerText = `Цена:${(
                    +priceSplit * +counter.value
                  ).toFixed(1)}`;
                } else {
                  price[1].innerText = `Цена:${
                    priceSplit / (+counter.value + 1)
                  }`;
                }
              }
            }
          });
        }

        addProductsBasket() {
          let i = 0;
          let j = 1;
          let cardItemHTML = "";
          let modalHtml = "";
          let summa = 0;
          let selectSize = "";
          let modalCardElement;
          let customBurger = {};
          let modalCardElementPrice;
          let smmaPriceModal = 0;
          let orderModal = {};

          let localStorageOrederModal;
          let localStorageOreder;
          let contentBox3 = document.getElementById("box3");
          let basket_products = document.querySelector(".basket-products");
          let orderID = 0;
          let card2;

          window.addEventListener("click", (event) => {
            if (event.target.id === "button-buy") {
              let card = event.target.closest("#food-card");
              let discription = card.querySelectorAll("#discription-food p");
              let food_img = card.querySelector("#photo-food img").src;
              let name_food = discription[0].innerText;
              let price_food = discription[1].innerText.split(":")[1];
              let btn = card.querySelector("#button-buy");
              let amount_food = card.querySelector("#amount-food").value;
              let categotyID = event.target.id;

              if (this.typeProduct === "sandwiches") {
                let modalBottom = document.getElementById("modal-bottom");
                let selectSize = "";
                let foodCategory = this.foods.sizes;

                console.log("amount_food", amount_food);

                contentBox3 = renderModalDialog(
                  selectSize,
                  modalHtml,
                  foodCategory,
                  i,
                  price_food,
                  smmaPriceModal,
                  categotyID,
                  modalBottom
                );

                let modal = document.getElementById("modal-content");
                let modalClose = document.getElementById("close-moala");
                let menuItem = document.getElementById("menu-modal");
                modalBottom =
                  document.querySelector("#modal-bottom p").innerText;
                let click = document.getElementById("sizes");

                modal.addEventListener("click", (e) => {
                  if (e.target.id === "modal-content") {
                    modal.remove();
                  }
                });

                setTimeout(() => {
                  click.click();
                }, 100);
                modal.showModal();

                menuItem.addEventListener("click", (e) => {
                  let categoryID = e.target.value;
                  selectSize = "";
                  let smmaPriceModalHTML;
                  let size_selection =
                    document.getElementById("size-selection");

                  let modalBottom = document.getElementById("modal-bottom");
                  let categotyID = e.target.id;
                  let foodCategory = this.foods[`${categotyID}`];

                  renderModalDialog2(
                    selectSize,
                    modalHtml,
                    foodCategory,
                    i,
                    price_food,
                    smmaPriceModal,
                    categotyID,
                    size_selection,
                    modalBottom
                  );

                  let selecteds = document.querySelectorAll(".selected");
                  smmaPriceModal = document
                    .querySelector("#modal-bottom p")
                    .innerText.split(":")[1];
                  smmaPriceModal = +smmaPriceModal.split(" ")[0];
                  console.log(smmaPriceModal);

                  selecteds.forEach((element) => {
                    element.addEventListener("click", () => {
                      modalCardElement = element.querySelectorAll("p");
                      modalCardElementPrice =
                        modalCardElement[1].innerText.split(" ")[0];
                      modalCardElement = modalCardElement[0].innerText;

                      smmaPriceModal =
                        Number(smmaPriceModal) + Number(modalCardElementPrice);
                      console.log(smmaPriceModal);

                      smmaPriceModalHTML = `<p>Итого:${smmaPriceModal}!! руб</p> `;

                      modalBottom.innerHTML = smmaPriceModalHTML;

                      localStorageOrederModal = JSON.parse(
                        localStorage.getItem("customBurger")
                      );

                      if (localStorageOrederModal == null) {
                        customBurger["name"] = name_food;
                        customBurger[categoryID] = modalCardElement;

                        localStorage.setItem(
                          "customBurger",
                          JSON.stringify(customBurger)
                        );
                      } else {
                        localStorageOrederModal[categoryID] = modalCardElement;
                        localStorage.setItem(
                          "customBurger",
                          JSON.stringify(localStorageOrederModal)
                        );
                      }
                    });
                  });

                  if (e.target.id === "ready") {
                    let modalBottom = document.getElementById("modal-bottom");
                    selectSize = "";
                    let selectSize2 = "";
                    customBurger = JSON.parse(
                      localStorage.getItem("customBurger")
                    );

                    let modalReady = renderModalReadyOrder(
                      customBurger,
                      selectSize,
                      selectSize2,
                      modalHtml,
                      size_selection,
                      food_img,
                      name_food,
                      smmaPriceModal,
                      modalBottom,
                      amount_food
                    );
                    console.log("ready modal", modalReady);

                    modalReady.addEventListener("click", (e) => {
                      if (e.target.id === "button-add-basket") {
                        modalReady = document.getElementById("amount-foods");
                        let smmaPrice =
                          document.getElementsByClassName("smmaPrice")[0];
                        console.log("summaPrice", smmaPrice);
                        amount_food = +modalReady.value;
                        customBurger.amount = amount_food;
                        localStorage.setItem(
                          "customBurger",
                          JSON.stringify(customBurger)
                        );

                        this.order = setSandwichesInOrder(
                          this.order,
                          customBurger
                        );

                        let render = renderFoodInBasket(
                          this.order,
                          cardItemHTML,
                          orderID,
                          resultSumma
                        );

                        basket_products.innerHTML += `${render}<br>`;

                        localStorage.removeItem("customBurger");
                      }
                    });
                  }
                });

                modalClose.addEventListener("click", () => {
                  modal.remove();
                });
              } else {
                let basket_products =
                  document.querySelector(".basket-products");
                let name_food = discription[0].innerText;
                let resultSumma = document.getElementById("totalSumm");

                localStorageOreder = localStorage.getItem("order");
                localStorageOreder = JSON.parse(localStorageOreder);

                //если order null
                console.log("amount_food", amount_food);
                if (localStorageOreder == null) {
                  this.order.push({
                    id: orderID,
                    name: name_food,
                    price: price_food,
                    amount: amount_food,
                  });
                  localStorage.setItem("order", JSON.stringify(this.order));
                } else {
                  this.order = localStorageOreder;
                  localStorage.setItem("order", JSON.stringify(this.order));
                  this.order.push({
                    id: orderID,
                    name: name_food,
                    price: price_food,
                    amount: amount_food,
                  });
                  localStorage.setItem("order", JSON.stringify(this.order));
                }

                let renderBasket = renderFoodInBasket(
                  this.order,
                  cardItemHTML,
                  orderID
                );
                orderID++;
                price_food = Number(price_food);
                summa = summa + price_food;
                calculationOfTheTotalPrice(
                  basket_products,
                  renderBasket,
                  price_food,
                  summa,
                  resultSumma
                );
              }
            }
            deleteFood(orderID, resultSumma, basket_products);
          });

          let resultSumma = document.getElementById("totalSumm");

          reloadingCartDataToClick(basket_products, orderID, resultSumma);

          console.log("resultSumma", resultSumma);
          loadingCartData(basket_products, resultSumma);
        }
      }
      let products = new Products();
      products.render();
      products.orderQuantity();
      products.addProductsBasket();
    </script>
  </body>
</html>
